## Link:
- [**From the February 2002 issue of MSDN Magazine**](https://learn.microsoft.com/en-us/archive/msdn-magazine/2002/february/inside-windows-win32-portable-executable-file-format-in-detail)
- [**IMAGE_NT_HEADERS32 structure (winnt.h)**](https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers32)
- [**IMAGE_FILE_HEADER structure (winnt.h)**](https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_file_header)
- [**IMAGE_OPTIONAL_HEADER32 structure (winnt.h)**](https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_optional_header32)

Sezioni del file PE:

**.text**: contiene le istruzioni per la CPU eseguite quando il file PE è avviato  
**.data**: contiene le variabili globali e altri dati globali  
**.rdata** o **idata** (import) o **edata** (export): contiene import/export di Windows API e DLL  
**.ndata**: contiene dati non inizializzati  
**pdata**: solo dei file a 64bit e contiene informazioni per l'handling delle eccezioni  
**.reloc**: contiene informazioni sulle riallocazioni  
**.rsrc**: contiene risorse come immagini, icone e altro usato dal file PE  
**debug**: contiene informazioni di debug  

Ogni sezione contiene:
- **VirtualAddress**: questo campo contiene informazioni del **Relative Virtual Address (RVA)**.
- **VirtualSize**: questo campo indica la dimensione una volta caricato in memoria.
- **SizeOfRawData**: questo campo rappresenta la dimensione della sezione su disco prima che il file PE sia caricato in memoria.
- **Characteristics**: informa sui permessi della sezione, esempio WRITE, EXECUTE e READ.

Il formato File PE (Portable Execution) è derivato dal COFF (Common Object File Format) dei sistemi VAX/VMS (DEC -> Compaq -> HP) (Gruppo di svoluppo WindowsNT arrivava da DEC).  

Questo formato permette l'utilizzo degli stessi eseguibili in diverse architetture e versioni di Windows (sempre nei limiti dei requisiti di sistema).  

Gli header di un file PE sono di tipo _**struct**_.

<img src="https://blogs.blackberry.com/content/dam/blogs-blackberry-com/images/blogs/2020/08/pe-tree-fig1.png" alt="pe-file-format" widht="100%" height="auto">

**`IMAGE_DOS_HEADER`** consiste nei primi 64 byte del file PE.  
I primissimi byte dell'header sono `0x4D` `0x5A` che in ASCII si traducono in [**MZ**](https://en.wikipedia.org/wiki/Mark_Zbikowski) che quando presenti sono interpretati da Windows come segnale univoco che il file in oggetto sia un Portable Executable. Lo scopo del DOS Header è di garantire compatibiltà tra MS-DOS e Windows.  
Nella variabile **`e_lfanew`** è salvato l'indirizzo da cui inizia l'header **`IMAGE_NT_HEADERS`**.

**`DOS_STUB`**  viene eseguito solo quando il file PE risulti incompatibile con il sistema in cui è eseguito.  

L'header **`IMAGE_NT_HEADERS`** contiene informazioni importanti sul file PE, ed è costituito da:
- **Signature**: ovvero 4 byte che identificano il file come immagine PE (`0x00004550` EP - nella corretta endiannes => **PE**)
- **FileHeader**: 
    - **Machine**: menziona il tipo di architettura per la quale il file PE è stato scritto, esempio `i386`.
    - **NumberOfSections**: questo campo identifica il numero di sezioni (dove codice, variabili e altre risorse sono memorizzate) che ha il file PE.
    - **TimeDateStamp**: questo campo contiene il data e ora della compilazione del file. 
    - **PointerToSymbolTable** e **NumberOfSymbols**: quesi campi non sono generalmente correlati al file PE ma più un retaggio degli header del COFF.
    - **SizeOfOptionalHeader**: questo campo contiene la dimensione del'header opzionale. 
    - **Characteristics**: questo campo identifica diverse caratteristiche del file PE, esempio `0x0103 RELOCS_STRIPPED | EXECUTABLE_IMAGE | 32BIT_MACHINE`.
- **OptionalHeader**: 
    - **Magic**: Il _Magic number_ definisce se si tratta di un file PE a 32 o 64 bit, esempio `0x010B` (32bit) o `0x020B` 64-bit.
    - **AddressOfEntryPoint**: questo campo è importante durante le fasi di **reverse engineering/malware analysis** perché contiene l'indirizzo da cui Windows inizierà l'esecuzione. Contiene l'indirizzo della prima istruzione che sarà eseguita. L'indirizzo è un **Relative Virtual Address (RVA)**, ovvero un offset relativo all'indirizzo di base dell'immagine (**ImageBase**) una volta caricato in memoria.
    - **BaseOfCode** e **BaseOfData**: indirizzi delle sezioni code e data relative alla ImageBase.
    - **ImageBase**: l'ImageBase è l'indirizzo preferito per il caricamento del file PE in memoria. Generalmente l'ImageBase per i file .exe è `0x00400000`. Siccome Windows non può caricare tutti i file PE allo stesso indirizzo, sono eseguite delle riallocazioni relative al ImageBase.
    - **Subsystem**: questo rappresenta il Subsystem necessario per eseguire l'immagine. Il Subsystem può essere Windows Native, GUI (Graphical User Interface), CUI (Commandline User Interface), o di altro tipo.
    - **DataDirectory**: il DataDirectory è una struttura che contiene informazioni di import/export del file PE (Import Address Table and Export Address Table).

**`IMAGE_SECTION_HEADER`** contiene informazioni sulle sezioni. 
Ad esempio, se la **VirtualSize** è (di molto) superiore alla **RawSize** (specialmente se applicato alla sezione .text) significa che la sezione occuperà più spazio in memoria che sul disco, ma soprattutto che il file è quasi sicuramente compresso/packed.  

**`IMAGE_IMPORT_DESCRIPTOR`** contiene le Windows API di cui il file PE ha bisogno per eseguire lo scopo per cui è stato creato. L'analisi di questo header aiuta nell'identificare, anche solo a grandi linee, quali azioni il file potrebbe compiere.

Le funzioni possono essere importate staticamente, ovvero l'intero codice della DLL o funzione è caricato nel file eseguibile, oppure dinamicamente o a runtime, ovvero le funzioni sono importate solo quando richieste (ad esempio usando **LoadLibrary** e **GetProcAddress**).

Al fine di rendere più difficile l'analisi statica del malware, gli autori ricorrono a operazioni di packing. Segnali ne sono:
- nomi delle sezioni non convenzionali o mancanti
- permesso EXECUTE per sezioni multiple
- un valore elevato di entropia (8+)
- una differenza significativa tra SizeOfRawData e Misc_VirtualSize di alcune sezioni PE
- import di poche funzioni

Gli **EXPORT** sono tipici delle DLL in quanto servono da "entrypoint" per altri programmi, generalmente .exe, per attivare o comunque sfruttare la funzione esposta.