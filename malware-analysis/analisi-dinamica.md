## Analisi delle DLL

Per eseguire le DLL è necessario usare il programma `rundll32.exe` seguendo la sintassi `rundll32.exe DLLname, Export arguments`.  
Gli export di una DLL sono documentate, quando questa è legittima, o individuabili eseguendo l'analisi statica della DLL e possono essere invocati sia tramite nome che tramite numero ordinale. 
Entrypoint interessante nei malware è la funzione `DLLmain` eseguito al caricamento della DLL e che contiene le risorse importanti.  

È possibile modificare una DLL in un EXE eliminato il flag `IMAGE_FILE_DLL` (0X2000) dal campo **Caratteristiche** (Characteristics) nel `IMAGE_FILE_HEADER`.  
In questo modo Windows *dovrebbe* eseguire DLLmain e quindi eseguirne l'analisi anche se questa modifica potrebbe comportare il crash del malware o comunque conseguenze inaspettate.

In alcuni casi una DLL richiede che sia installata come servizio per poter funzionare e quindi diventa necessario registrarla come tale. A tal fine la stessa DLL potrebbe contenere un export ad hoc, oppure l'analista usare il comando `sc` (o agire nel Registro di Sistema alla chiave **HKLM\SYSTEM\CurrentControlSet\Services**) per registrare un nuovo servizio o modificarne uno esistente ma non necessario o core.

## Analisi delle chiamate API

Strumenti come **API Logger** ed **API Monitor** sono tool utili per l'analisi delle chiamate alle API con relativi parametri.

## Analisi dei processi

**ProcessMonitor** e **ProcessExplorer** utili per analizzare il comportamento dei processi, il primo nel comportamento il secondo in altri dettagli.

In **ProcessMonitor** è possibile filtrare l'elenco dei dati raccolti sui processi in esecuzione per nome, architettura, traffico di rete, parentela...  
È quindi uno strumento utile per catturare gli eventi durante l'esecuzione del malware e iniziare una prima analisi dinamica sul file di cattura. Partendo da una prima scrematura partendo da informazioni note dalla prima analisi statica è possibile filtrare gli evwnti e raccogliere informazioni più dettagliate di operazioni su file e cartelle, registro di sistema e rete.

In **ProcessExplorer** è inoltre possibile **verificare** (pulsante **Verify** nella tab **Image** delle proprietà di un processo) nelle proprietà del processo verificare se il file .exe è digitalmente firmato (questa verifica si limita al file **su disco e non in memoria**).  
Tramite la comparazione di stringhe, nella tab _Strings_, è possibile verificare se il contenuto del file su disco _Image_ è uguale o diverso da quanto caricato in memoria (attacco di ProcessHollowing).  

ProcessExplorer permette sia di controllare le dipendenze di un processo sfruttando DependencyWalker e di recuperare gli handle o DLL. L'opzione di ricerca delle DLL è utile per risalire a quale processo ne fa uso e quindi risalire al processo malevolo.

## Analisi del Registro di Sistema

L'analisi del registro di sistema è utile per determinare il comportamento del malware. Tool come **RegShot** scansionano il registro e le cartelle indicate prima e dopo l'esecuzione del malware e restituiscono le differenze. 

Quando un malware si registra come servizio specifica anche il tipo di avvio:  
|Costante|Valore|Descrizione|
|-|-|-|
|WIN32_SERVICE_BOOT_START|	0x00000000	|A device driver started by the system loader. This value is valid only for driver services.|
|WIN32_SERVICE_SYSTEM_START|	0x00000001	|A device driver started by the IoInitSystem function. This value is valid only for driver services.|
|WIN32_SERVICE_AUTO_START	|0x00000002	|A service started automatically by the service control manager during system startup.|
|WIN32_SERVICE_DEMAND_START	|0x00000003	|A service started by the service control manager when a process calls the StartService function.|
WIN32_SERVICE_DISABLED|	0x00000004	|A service that cannot be started Attempts to start the service result in the error code WIN32_ERROR_SERVICE_DISABLED.|

## Analidi del traffico dati

Molti malware sono programmati per comunicare con risorse esterne come server C2. Per questo diventa importante riuscire a catturare le richieste DNS, HTTP, HTTPS, gli indirizzi IP, i parametri e così via utilizzati dal malware.  
Usando software che simulano una rete o usando una VM che fornisce servizi di rete (ma comunque limitati alla rete interna tra VM) è possibile trarre in inganno il malware e raccogliere quelli che sono artefatti di rete.  
L'analisi dei file PCAP generati può rivelare ulterioi informazioni utili.

## Uso di Debuggers

L'uso di debuggers permette un analisi dinamica avanzata in quanto è possbile manipolare a piacimento l'esecuzione di un malware e di modificarne temporaneamente il contenuto per disarmare eventuali tecniche di evasione.

**Breakpoint software** corrispondono a istruzione `0xCC`. Nel momento in cui il programma esegue l'istruzione, viene generata un'eccezione e il controllo passa al debugger.  
**Breakpoint hardware** sono posizioni a indirizzi specificati dal analista e sono utili per analizzare codice/istruzioni che modificano sè stesse. Nel caso dei breakpoint software, gli stessi breakpoint sarebbero sovrascritti.  
I breakpoint hardware sono salvati in registri di sistema e quindi, siccome ogni registro dedicato ne memorizza uno, si possono impostare pochi breakpoint hardware contemporaneamente.  
**Breakpoint condizionali** si possono configurare quando si avverano determinati eventi, ad esempio il valore di una funzione fa match.  

**First chance exceptions** sono eccezioni generate quando un programma incontra un errore ma non tale da causarne la chiusura. Queste eccezioni possono essere gestite dal debugger o lasciate in "gestione" al programma analizzato.  
**Second chance exceptions** sono eccezioni generate quando un programma incontra un errore tale da causarne la chiusura. Il debugger intercetta l'eccezione e prende il controllo del flusso dell'esecuzione.  

Quando un malware si chiude anticipatamente perché le regole di prevenzione di esecuzione in ambiente di debug fanno match, genera una second chance exception.

Come scritto sopra, i debugger prendono il controllo dell'esecuzione del programma analizzato attraverso le eccezioni. Di queste le più comuni sono:
- `INT 3` (0xCC) genera una first chance exceptions
- `trap flag` nel registro dei FLAG per la funzione *single-stepping*
- `memory access violation` quando il programma fa riferimento a un indirizzo di memoria invalido perché non più presente o riservato/protetto

*Privileged mode* = kernel mode  
*Unprivilege mode* = user mode

### Kernel-Mode Debugging

Il debugging del Kernel non è semplice in quanto fermare l'esecuzione del kernel per analisi significa fermare il sistema operativo.  
Il primo, e forse unico, software che permette l'analisi dinamica del kernel è SoftIce supportato nei sistemi ormai considerati legacy.  
Ad oggi il solo modo per effettuare il debugging del kernel è quello di usare due sistemi: uno per eseguire il payload da analizzare e uno per eseguire il debugger.  
Due VM rendono questa procedura agevole.

In ambienti Windows il debugger di riferimento per l'analisi del kernel è WinDbg.

## Tecniche di Dynamic Analysis Evasion

- identificazione dell'ambiente in cui il malware è eseguito, se riconosce tratti (come driver di VM (VMWare, Virtualbox...), RAM e CPU limitate...) tipici di sistemi virtualizzati, non viene eseguita alcuna operazione malevola o addirittura sono eseguite operazioni "benevole"
- identificazione dell'ambiente tramite lunghe attese nelle chiamate di funzione usando, ad esempio, la libreria Sleep di Windows. Questi controlli prevedono appunto lunghe attese, anche di giorni, prima di effettuare funzioni malevole nel tentativo di aggirare le sandbox (o simili) che rimangono attive per pochi minuti. Alcuni di questi strumenti di analisi dinamica tentano di aggirare queste tecniche manipolando data e ora del sistema operativo, a cui i malware possono rispondere comparando il tempo di prima esecuzione con quello rilevato alla fine del tempo di sospensione imposto della funzione sleep
- identificazione dell'ambiente in base all'attività dell'utente... pochi file, poca o nulla cronologia, assenza di movimento del mouse e della tastiera
- identificazione di strumenti di analisi come ProcMon, ProcExp e simili sia se in esecuzione, sia se risultano tra i processi in uso


