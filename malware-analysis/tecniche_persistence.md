## DLL/EXE

- installazione come servizio in avvio automatico
- sostituzione a DLL esistenti
- copia della DLL in percorsi noti come `C:\Windows\System32\` con nomi verosimili come `kerne132.dll`
- modifica dei file .exe per import di libreria custom (come sopra) in modo che qualsiasi .exe presente nel sistema ne faccia uso

### File PE (eseguibili e DLL) di sistema trojanized

I malware patchano file binari di sistema al fine di inserire in coda allo stesso il codice necessario all'esecuzione dell'attività malevola che viene invocata tramite un *jmp* a cui segue un *ret* alla funzione originale, in modo da non alterare il corretto funzionamento del sistema.

### Hijacking dell'ordine di caricamento delle DLL
[*T1574.001*](https://attack.mitre.org/techniques/T1574/001/)

Quando un file binario richiede l'accesso a una DLL, Windows esegue la ricerca della DLL seguendo un ordine ben preciso:

1. [DLL Redirection](https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-redirection)
2. [API sets](https://learn.microsoft.com/en-us/windows/win32/apiindex/windows-apisets)
3. [SxS manifest redirection](https://learn.microsoft.com/en-us/windows/win32/sbscs/manifests)
4. Lista dei moduli già caricati in memoria
5. DLL note (`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs`)  
(**BONUS**. Windows 11, version 21H2 (10.0; Build 22000), and later. The package dependency graph of the process. This is the application's package plus any dependencies specified as <PackageDependency> in the <Dependencies> section of the application's package manifest. Dependencies are searched in the order they appear in the manifest.)
6. La cartella da cui è eseguita l'applicazione
7. La cartella System (`C:\Windows\System32`) recuperata con la funzione [GetSystemDirectory](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getsystemdirectorya)
8. La cartella di sistema a 16 bit (nessuna API disponibile per recupare il percorso della cartella ma viene comunque effettuata la ricerca)
9. La cartella Windows (`C:\Windows`) recuperata con la funzione [GetWindowsDirectory](https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-getwindowsdirectorya)
10. La cartella corrente
11. Le cartella elencate nella variabile d'ambiente **PATH**. Non include percorsi specifici dichiarati *per-applicazione* specificati nella chiave di registro *App Paths*.

In sistemi legacy o se la ricerca sicura delle DLL è disattivata (`HKLM\System\CurrentControlSet\Control\Session Manager\SafeDllSearchMode`) le posizioni 8 e 11 sono invertite.

Eventuali punti cieci nell'ordine di caricamento possono essere sfruttate da TA e malware per inserire un DLL malevola e anticipare il caricamento della DLL legittima.

## Registro di sistema
[*T1547.001*](https://attack.mitre.org/techniques/T1547/001/)

- creazione o modifica di voci al percorso `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`

### AppInit_DLLs
[*T1546.010*](https://attack.mitre.org/techniques/T1546/010/)

La chiave di registro `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows` contiene la sottochiave `AppInit_DLLs`. Questo sistema permette di effettuare l'hooking di API caricando DLL custom nell'address space di ogni applicazione interattiva (DLL caricate da User32.dll caricata a sua volta dai processi delle applicazioni).  
**SecureBoot**, quando attivo, disabilita questa funzione al fine di mitigare possibili usi di questa funzione da parte di malware e TA.  

### Winlogon Notify
[*T1547.004*](https://attack.mitre.org/techniques/T1547/004/)

La chiave di registro `Notify` che si trova al percorso `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon` può contenere indicazioni su quale DLL Windows deve usare per gestire gli eventi generati da **winlogon.exe**.  

### SvcHost DLLs
[*T1543.003*](https://attack.mitre.org/techniques/T1543/003/)

Il processo **svchost.exe** è un processo generico per servizi che sono eseguiti da DLL.  
Ogni istanza di svchost.exe fa riferimento a un determinato *gruppo* di servizi (i gruppi sono preconfigurati in Windows) e sono definiti al percorso `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost`.  
I servizi sono invece definiti al percorso `HKLM\SYSTEM\ControlSet001\Services`.  
Al fine di celare la propria esistenza, i malware si nascondono dietro servizi con nomi apparentemnte legittimi, nei gruppi di servizi avviati poi da una istanza di svchost.exe.  
I malware possono creare un servizio a loro uso e costume oppure alterare il funzionamento di servizi esistenti.

## Rootkits

### Inline e Import Address Table Hooking  
[*T0874*](https://attack.mitre.org/techniques/T0874/)

I rootkit sono spesso installati a livello di kernel al fine di ottenere il controllo completo sulla macchina e poter nascondere in modo efficace le proprie tracce.  
Esistono anche versioni di rootkit che sono installati a livello di user (user-space).  

Un sistema che usano i rootkit per alterare il funzionamento del sistema, come ad esempio nascondere il traffico generato verso la porta TCP 443 (HTTPS) al fine di celare le proprie comunicazioni con l'esterno, consiste nell'eseguire l'hooking dell'Import Address Table o un hooking "inline".  

Nel primo caso l'indirizzo di uno o più import è alterato in modo che quando l'applicazione esegue una chiamata di funzione a quella specifica import, subentri il rootkit che altera il funzionamento (ad esempio impedisce all'applicazione di chiudersi) per poi passare il controllo all'import legittimo oppure interrompere il passaggio di consegna.  

Nel secondo caso invece, il rootkit inietta del codice in uno spazio "vuoto" in una chiamata di funzione (ad esempio patchando una chiamata a un valore NULL). In quello spazio il codice malevolo viene iniettato ed eseguito senza alterare il flusso della funzione originale.

