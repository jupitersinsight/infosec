## Strings

Ricerca di stringhe che possono rivelare informazioni sulmalware, spesso nascoste/sporcate nell'insieme del file PE, oppure codificate una a una.  
Analisi che potrebbe rivelare informazioni utili.

## Imphash

I malware sono ridentificati tramite hash. Una hash è calcolata in base al contenuto di un file, per cui una piccola modifica del contenuto genererà una hash totalmente diversa dalla precedente. Un modo per identificare malware affini o comunque "imparentati" è l'analisi delle hash prodotte dagli import di funzioni esterne (da DLL o altre fonti).

## Fuzzy hashes/SSDEEP

Hash calcolata dividendo il file in diversi segmenti di pari lunghezza. Per ogni segmento è calcolata l'hash.

## Signatures

Sequenza di byte in un file che ne permettono l'identificazione.


## Reverse Engineering (Ghidra)

Per iniziare l'analisi di un file compilato:
- partire dalla funzione principale nel _Symbol Tree_
- partire dalla sezione _.text_
- cercare _stringhe_ interessanti

Esempi di costrutti in C e relativo assembly:

**For loop**
```c
int main() {
    for (int i = 1; i <= 5; i++) {
        std::cout << i << std::endl;
    }
    return 0;
}
```
```assembly
main:
    ; inizializza il contatore del loop a 1
    mov ecx, 1

    ; loop 5 volte
    mov edx, 5
loop:
    ; stampa il contatore del loop
    push ecx
    push format
    call printf
    add esp, 8

    ; incrementa il contatore
    inc ecx

    ; controlla se il loop è terminato
    cmp ecx, edx
    jle loop
```
**Funzione**
```c
int add(int a, int b){
    int result = a + b;
    return result;
}
```
```assembly
add:
    push ebp          ; salva il valore del base pointer corrente
    mov ebp, esp      ; imposta il base pointer al valore dello stack pointer
    mov eax, dword ptr [ebp+8]  ; sposta il valore di 'a' nel registro eax
    add eax, dword ptr [ebp+12] ; aggiunge il valore di 'b' al registro eax
    mov dword ptr [ebp-4], eax  ; sposta la somma nella variabile 'result'
    mov eax, dword ptr [ebp-4]  ; sposta il valore di 'result' nel registro eax
    pop ebp           ; ripristina il precedente valore del base pointer
    ret               ; ritorna alla chiamata di funzione
```
**While Loop**
```c
int i = 0;
while (i < 10) {
    printf("%d\\n", i);
    i++;
}
```
```assembly
mov ecx, 0     ; inizializza i a 0
loop_start:
cmp ecx, 10    ; compara i a 10
jge loop_end   ; salta a loop_end se i >= 10
push ecx       ; salva il valore di i nello stack
push format    ; push la stringa format per printf
push dword [ecx]; push del valore di i per printf
call printf    ; chiama printf per stampare il valore di i
add esp, 12    ; ripulisci lo stack
inc ecx        ; incrementa i
jmp loop_start ; salta indietro all'inizio del loop
loop_end:
```

È importante analizzare la sezione degli **Import** in quanto in base alle API importate è possibile identificare a grand linee il tipo di malware e il suo comportamento:

**C2 Communication**
- **InternetOpen**: inizializza una sessione per connettersi a internet e comunicare con server C2
- **InternetOpenUrl**: apre una URL per il download di codice dal server C2
- **HttpOpenRequest**: apre richieste HTTP per comunicare col server C2 al fine di ricevere istruzioni o scaricare altro codice
- **HttpSendRequest**: invia richieste HTTP per comunicare col server C2 al fine di ricevere istruzionio inviare dati

**Data Exfiltration**
- **InternetReadFile**: trasferimento di dati in lettura da un file locale a una risorsa remota come un server C2
- **FtpPutFile**: caricamento di file a un server FTP
- **CreateFile**: crea o modifica file o dispositivi al fine modificare file con informazioni sesnsibili o di sistema
- **WriteFile**: scrive dati a un file o dispositivo, usato prima per scrivere informazioni in un file locale per poi esfiltrarlo
- **GetClipboardData**: usata per recuperare informazioni contenute della clipboard

**API Hooking**  
-**GetProcAddress**: recupera l'indirizzo di una funzione esportata o variabile da una DLL, al fine di individuare e agganciare (hook) chiamate ad API fatte da altri processi
- **LoadLibrary**: carica una DLL per usarne le funzioni
- **SetWindowsHookEx API**: installa una hook procedure che monitora messaggi inviati a una finestra o a eventi di sistema, catturando chiamate di altre processi alle API un malware può modificarne il comportamento (come usa sorta di MiTM)

**Anti-debugging and VM detection**
- **IsDebuggerPresent**: controlla se un processo è in uso da un debugger
- **CheckRemoteDebuggerPresent**: controlla se un debugger remoto sta analizzando il processo
- **NtQueryInformationProcess**: recupera informazioni su uno specifico processo, al fine di valutare se il malware sta usando le sue capacità di evasione in maniera corretta
- **GetTickCount**: recupera il numero di millisecondi che sono trascorsi da quando il sistema è stato avviato, usato per determinare se il malware si trova in un ambiente virtuale e quindi che probabilmente è in corso un'analisi
- **GetModuleHandle**: funzione che recupera un handle a un modulo specifico
- **GetSystemMetrics**: recupera diversi valori di riferimento del sistema e configurazioni di sistema

Uno dei sistemi più usati per evadere controlli in uso nel sistema si chiama [**Process Hollowing**](https://attack.mitre.org/techniques/T1055/012/) e consiste nello sospendere un processo legittimo appena creato, caricare al suo indirizzo di memoria il codice malevolo e riesumare il processo in modo il codice sia eseguito nel suo contesto di processo considerato sicuro.

## Tecniche di Static Analysis Evasion

- modifica del contenuto del malware al fine di aggirare controlli basati sulle hash
- obfuscation del codice e modifica di parte dello stesso per aggirare tecniche basate sulle signature
- obfuscation delle stringhe (poi decodificate in runtime)
- uso di funzioni come LoadLibrary e LoadLibraryEx per evitare che l'analisi statica degli import riveli informazioni sulle funzioni necessarie al malware (librerie caricate in runtime)
- packing e obfuscation nascondono il contenuto del malware all'analisi statica

Tools come **PEStudio** e **DetectItEasy** possono identificare se un file PE è packed e quale packer sia stato usato + plugin **Scylla** per x32/64dbg.
Packing non serve quando malware è caricato in memoria quindi con debugger è possibile analizzare il malware.

I malware che fanno uso di tecniche di **obfuscation** e **packing** includono, come set minimo, le funzioni [**LoadLibrary**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya) e [**GetProcAddress**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress).